<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: #1a5276; color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        #status { display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 20px; text-align: center; padding: 20px; }
        #game-container { display: none; padding: 20px; }
        .lilypad { width: 100px; height: 60px; background: green; border-radius: 50%; display: inline-block; margin: 20px; cursor: pointer; color: black; line-height: 60px; font-weight: bold; text-align: center; }
        .frog { font-size: 50px; position: absolute; transition: all 0.5s; top: 200px; left: 50px; }
    </style>
</head>
<body>
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</div>
    <div id="game-container">
        <h2 id="quest-title"></h2>
        <div id="question-text" style="font-size: 24px; margin-bottom: 20px;"></div>
        <div id="pads-container"></div>
        <div id="frog" class="frog">üê∏</div>
    </div>
<script>
// =====================================================
// 1. –ó–ê–©–ò–¢–ê ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º iframe –ò Genially
// =====================================================
// Genially –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ —Å–≤–æ–µ–≥–æ iframe,
// –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä—è–µ–º referrer –≤–º–µ—Å—Ç–æ window.self === window.top
(function() {
    var isIframe = (window.self !== window.top);
    var isLocalhost = window.location.href.indexOf('localhost') !== -1;
    var isFile = window.location.protocol === 'file:';
    var ref = document.referrer || '';
    var isGenially = ref.indexOf('genially') !== -1 || ref.indexOf('genial.ly') !== -1;

    // –†–∞–∑—Ä–µ—à–∞–µ–º: iframe, localhost, file://, referrer –æ—Ç Genially
    if (!isIframe && !isLocalhost && !isFile && !isGenially) {
        document.body.innerHTML = '<h1 style="padding:40px;text-align:center;">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–≥—Ä—É —á–µ—Ä–µ–∑ Genially.</h1>';
        throw new Error('Access denied ‚Äî not in iframe');
    }
})();

// =====================================================
// 2. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// =====================================================
var gameData = null;
var currentLevelIndex = 0;
var currentQuestionIndex = 0;
var lives = 5;

// =====================================================
// 3. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –° GITHUB
// =====================================================
function loadGame() {
    var id = new URLSearchParams(window.location.search).get('id');

    if (!id) {
        document.getElementById('status').textContent = '–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –∏–≥—Ä—ã (?id=...)';
        return;
    }

    var url = 'https://vera422.github.io/texts/data/' + id + '.json';

    console.log('[Froggy] –ó–∞–≥—Ä—É–∑–∫–∞:', url);

    fetch(url)
        .then(function(res) {
            if (res.status === 404) {
                document.getElementById('status').innerHTML =
                    '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è... (–ø–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥)<br>' +
                    '<span style="font-size:14px;opacity:0.7;">GitHub Pages –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è</span>';
                setTimeout(loadGame, 5000);
                return null;
            }
            if (!res.ok) {
                throw new Error('HTTP ' + res.status);
            }
            return res.json();
        })
        .then(function(data) {
            if (!data) return; // 404 retry
            gameData = data;
            console.log('[Froggy] –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data);
            startGame();
        })
        .catch(function(e) {
            console.error('[Froggy] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
            document.getElementById('status').innerHTML =
                '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏<br>' +
                '<span style="font-size:14px;opacity:0.7;">' + e.message + '</span><br>' +
                '<button onclick="loadGame()" style="margin-top:15px;padding:10px 20px;font-size:16px;cursor:pointer;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>';
        });
}

// =====================================================
// 4. –ó–ê–ü–£–°–ö –ò–ì–†–´
// =====================================================
function startGame() {
    document.getElementById('status').style.display = 'none';
    document.getElementById('game-container').style.display = 'block';
    document.getElementById('quest-title').textContent = gameData.title || 'Froggy Quest';

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ JSON
    if (gameData.settings) {
        lives = parseInt(gameData.settings.lives) || 5;
    }

    currentLevelIndex = 0;
    currentQuestionIndex = 0;
    showCurrentQuestion();
}

// =====================================================
// 5. –ü–û–ö–ê–ó –í–û–ü–†–û–°–ê
// =====================================================
function showCurrentQuestion() {
    // –ù–∞—Ö–æ–¥–∏–º –≤–æ–ø—Ä–æ—Å—ã —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
    // –§–æ—Ä–º–∞—Ç –æ—Ç index.html: gameData.levels = { "1": [...], "2": [...] }
    var levelKeys = Object.keys(gameData.levels || {}).sort(function(a, b) {
        return parseInt(a) - parseInt(b);
    });

    if (currentLevelIndex >= levelKeys.length) {
        // –í—Å–µ —É—Ä–æ–≤–Ω–∏ –ø—Ä–æ–π–¥–µ–Ω—ã ‚Äî –ø–æ–±–µ–¥–∞!
        showVictory();
        return;
    }

    var levelKey = levelKeys[currentLevelIndex];
    var questions = gameData.levels[levelKey];

    if (!questions || questions.length === 0) {
        // –ü—É—Å—Ç–æ–π —É—Ä–æ–≤–µ–Ω—å ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        currentLevelIndex++;
        currentQuestionIndex = 0;
        showCurrentQuestion();
        return;
    }

    if (currentQuestionIndex >= questions.length) {
        // –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω ‚Äî —Å–ª–µ–¥—É—é—â–∏–π
        currentLevelIndex++;
        currentQuestionIndex = 0;
        showCurrentQuestion();
        return;
    }

    var q = questions[currentQuestionIndex];

    // –§–æ—Ä–º–∞—Ç –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç index.html:
    // { question: "She ___ a book", options: ["reads", "read", "reading"], correct: 0 }
    var questionText = q.question || q.q || '';
    var options = q.options || [];
    var correctIndex = q.correct || 0;

    // –ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è
    var levelName = '–£—Ä–æ–≤–µ–Ω—å ' + levelKey;
    if (gameData.levelMeta && gameData.levelMeta[levelKey] && gameData.levelMeta[levelKey].name) {
        levelName = gameData.levelMeta[levelKey].name;
    }

    document.getElementById('quest-title').textContent = levelName;
    document.getElementById('question-text').textContent =
        '–í–æ–ø—Ä–æ—Å ' + (currentQuestionIndex + 1) + ': ' + questionText;

    var container = document.getElementById('pads-container');
    container.innerHTML = '';

    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
    var shuffled = options.map(function(opt, idx) {
        return { text: opt, isCorrect: idx === correctIndex };
    });
    // Fisher-Yates shuffle
    for (var i = shuffled.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = shuffled[i];
        shuffled[i] = shuffled[j];
        shuffled[j] = tmp;
    }

    shuffled.forEach(function(item) {
        var pad = document.createElement('div');
        pad.className = 'lilypad';
        pad.textContent = item.text;
        pad.onclick = function() { checkAnswer(item.isCorrect); };
        container.appendChild(pad);
    });
}

// =====================================================
// 6. –ü–†–û–í–ï–†–ö–ê –û–¢–í–ï–¢–ê
// =====================================================
function checkAnswer(isCorrect) {
    var frog = document.getElementById('frog');

    if (isCorrect) {
        // –ü—Ä–∞–≤–∏–ª—å–Ω–æ!
        frog.style.transform = 'scale(1.3)';
        try { new Audio('https://raw.githubusercontent.com/vivanova288-boop/froggy-quest-builder-v3/main/2.mp3').play(); } catch(e) {}

        setTimeout(function() {
            frog.style.transform = 'scale(1)';
            currentQuestionIndex++;
            showCurrentQuestion();
        }, 600);
    } else {
        // –û—à–∏–±–∫–∞!
        lives--;
        frog.style.transform = 'scale(1.2) rotate(10deg)';
        frog.style.filter = 'hue-rotate(180deg)';
        try { new Audio('https://raw.githubusercontent.com/vivanova288-boop/froggy-quest-builder-v3/main/3.mp3').play(); } catch(e) {}

        setTimeout(function() {
            frog.style.transform = 'scale(1)';
            frog.style.filter = '';

            if (lives <= 0) {
                showGameOver();
            }
            // –û—Å—Ç–∞—ë–º—Å—è –Ω–∞ —Ç–æ–º –∂–µ –≤–æ–ø—Ä–æ—Å–µ
        }, 500);
    }
}

// =====================================================
// 7. –≠–ö–†–ê–ù–´ –ö–û–ù–¶–ê
// =====================================================
function showVictory() {
    var victoryText = (gameData.settings && gameData.settings.victoryText) || '–ü–û–ë–ï–î–ê! üéâ';
    document.getElementById('game-container').innerHTML =
        '<div style="text-align:center;padding:40px;">' +
        '<h1 style="font-size:3em;">' + victoryText + '</h1>' +
        '<p style="font-size:1.5em;">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</p>' +
        '<button onclick="location.reload()" style="padding:15px 30px;font-size:18px;cursor:pointer;border:none;border-radius:10px;background:#22c55e;color:white;font-weight:bold;">–ï—â—ë —Ä–∞–∑</button>' +
        '</div>';
}

function showGameOver() {
    var goText = (gameData.settings && gameData.settings.gameoverText) || '–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê üò¢';
    document.getElementById('game-container').innerHTML =
        '<div style="text-align:center;padding:40px;">' +
        '<h1 style="font-size:3em;">' + goText + '</h1>' +
        '<button onclick="location.reload()" style="padding:15px 30px;font-size:18px;cursor:pointer;border:none;border-radius:10px;background:#ef4444;color:white;font-weight:bold;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>' +
        '</div>';
}

// =====================================================
// 8. –°–¢–ê–†–¢
// =====================================================
loadGame();
</script>
</body>
</html>
